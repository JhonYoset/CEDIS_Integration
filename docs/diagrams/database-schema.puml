@startuml CEDIS_Database_Schema
!theme plain

title Sistema CEDIS - Esquema de Base de Datos
subtitle Estructura detallada de tablas y relaciones

!define table(x) class x << (T,#FFAAAA) >>
!define view(x) class x << (V,#FFAAFF) >>
!define enum(x) class x << (E,#AAFFAA) >>

table(usuarios) {
  ğŸ”‘ id : SERIAL PRIMARY KEY
  --
  nombre : VARCHAR(100) NOT NULL
  apellido : VARCHAR(100) NOT NULL
  correo : VARCHAR(150) UNIQUE NOT NULL
  tipo : usuario_tipo_enum NOT NULL
  fecha_creacion : TIMESTAMP DEFAULT NOW()
  fecha_actualizacion : TIMESTAMP DEFAULT NOW()
  --
  ğŸ“‹ Ãndices:
  â€¢ idx_usuarios_correo (correo)
  â€¢ idx_usuarios_tipo (tipo)
}

table(lectores) {
  ğŸ”‘ id : SERIAL PRIMARY KEY
  --
  tipo : lector_tipo_enum NOT NULL
  nombre : VARCHAR(100) NOT NULL
  apellido : VARCHAR(100) NOT NULL
  identificacion : VARCHAR(20) UNIQUE NOT NULL
  correo : VARCHAR(150) NOT NULL
  telefono : VARCHAR(15)
  fecha_registro : TIMESTAMP DEFAULT NOW()
  estado : BOOLEAN DEFAULT TRUE
  --
  ğŸ“‹ Ãndices:
  â€¢ idx_lectores_identificacion (identificacion)
  â€¢ idx_lectores_correo (correo)
  â€¢ idx_lectores_estado (estado)
}

table(categorias) {
  ğŸ”‘ id : SERIAL PRIMARY KEY
  --
  nombre : VARCHAR(100) UNIQUE NOT NULL
  descripcion : TEXT
  fecha_creacion : TIMESTAMP DEFAULT NOW()
  fecha_actualizacion : TIMESTAMP DEFAULT NOW()
  --
  ğŸ“‹ Ãndices:
  â€¢ idx_categorias_nombre (nombre)
}

table(documentos) {
  ğŸ”‘ id : SERIAL PRIMARY KEY
  --
  ğŸ”— categoria_id : INTEGER NOT NULL
  titulo : VARCHAR(200) NOT NULL
  autor : VARCHAR(150) NOT NULL
  editorial : VARCHAR(100) NOT NULL
  tipo : documento_tipo_enum NOT NULL
  fecha_publicacion : DATE
  fecha_registro : TIMESTAMP DEFAULT NOW()
  fecha_actualizacion : TIMESTAMP DEFAULT NOW()
  estado : documento_estado_enum NOT NULL
  --
  ğŸ“‹ Ãndices:
  â€¢ idx_documentos_categoria (categoria_id)
  â€¢ idx_documentos_titulo (titulo)
  â€¢ idx_documentos_autor (autor)
  â€¢ idx_documentos_tipo (tipo)
  â€¢ idx_documentos_estado (estado)
}

table(prestamos) {
  ğŸ”‘ id : SERIAL PRIMARY KEY
  --
  ğŸ”— lector_id : INTEGER NOT NULL
  ğŸ”— documento_id : INTEGER NOT NULL
  ğŸ”— usuario_id : INTEGER NOT NULL
  fecha_prestamo : DATE NOT NULL
  fecha_devolucion_programada : DATE NOT NULL
  fecha_devolucion_real : DATE
  estado : VARCHAR(20) NOT NULL
  observaciones : TEXT
  --
  ğŸ“‹ Ãndices:
  â€¢ idx_prestamos_lector (lector_id)
  â€¢ idx_prestamos_documento (documento_id)
  â€¢ idx_prestamos_usuario (usuario_id)
  â€¢ idx_prestamos_estado (estado)
  â€¢ idx_prestamos_fechas (fecha_prestamo, fecha_devolucion_programada)
}

enum(usuario_tipo_enum) {
  Administrador
  Bibliotecario
  Consultor
}

enum(lector_tipo_enum) {
  Estudiante
  Docente
  Administrativo
}

enum(documento_tipo_enum) {
  Libro
  Tesis
  Diapositiva
  Otro
}

enum(documento_estado_enum) {
  Disponible
  "No disponible"
  Reservado
}

' Relaciones Foreign Keys
categorias ||--o{ documentos : "categoria_id"
lectores ||--o{ prestamos : "lector_id"
documentos ||--o{ prestamos : "documento_id"
usuarios ||--o{ prestamos : "usuario_id"

' Constraints y Triggers
note top of usuarios
  <b>ğŸ”’ Constraints:</b>
  â€¢ correo debe ser Ãºnico
  â€¢ correo debe contener @
  â€¢ tipo debe ser vÃ¡lido
  
  <b>ğŸ”„ Triggers:</b>
  â€¢ update_fecha_actualizacion()
end note

note top of lectores
  <b>ğŸ”’ Constraints:</b>
  â€¢ identificacion debe ser Ãºnica
  â€¢ correo debe ser vÃ¡lido
  â€¢ telefono formato vÃ¡lido
  
  <b>âœ… Validaciones:</b>
  â€¢ estado activo para prÃ©stamos
end note

note bottom of prestamos
  <b>ğŸ”’ Constraints:</b>
  â€¢ fecha_devolucion_programada > fecha_prestamo
  â€¢ fecha_devolucion_real >= fecha_prestamo
  â€¢ estado IN ('Prestado', 'Devuelto', 'Atrasado')
  
  <b>ğŸ”„ Triggers:</b>
  â€¢ actualizar_estado_vencidos()
  â€¢ actualizar_stock_documento()
end note

note bottom of documentos
  <b>ğŸ”’ Constraints:</b>
  â€¢ titulo no vacÃ­o
  â€¢ categoria_id debe existir
  â€¢ fecha_publicacion <= fecha_registro
  
  <b>ğŸ“Š Funciones:</b>
  â€¢ calcular_disponibilidad()
end note

@enduml